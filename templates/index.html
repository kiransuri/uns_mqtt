<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factory Sensor Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Debug information
        console.log("Template loaded");
        console.log("Initial data:", {{ data|tojson|safe }});
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }
        .section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .sensor-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .sensor-card.temperature { border-left-color: #dc3545; }
        .sensor-card.pressure { border-left-color: #28a745; }
        .sensor-card.humidity { border-left-color: #17a2b8; }
        .sensor-card.vibration { border-left-color: #ffc107; }
        .sensor-card.power { border-left-color: #6f42c1; }
        
        .sensor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .sensor-title {
            font-weight: bold;
            color: #333;
        }
        .sensor-location {
            font-size: 0.9em;
            color: #666;
        }
        .sensor-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        .sensor-unit {
            font-size: 1.2em;
            color: #666;
        }
        .sensor-timestamp {
            color: #888;
            font-size: 0.8em;
        }
        .chart-container {
            height: 300px;
            margin-top: 20px;
        }
        h2 {
            color: #333;
            margin-top: 0;
        }
        #debug-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <h1>Factory Sensor Dashboard</h1>
        
        <div class="section">
            <h2>Environmental Sensors</h2>
            <div class="sensor-grid">
                <div class="sensor-card temperature" id="temp-zone1">
                    <div class="sensor-header">
                        <span class="sensor-title">Temperature</span>
                        <span class="sensor-location">Zone 1</span>
                    </div>
                    <div class="sensor-value">{{ data.temperature.zone1.value }}</div>
                    <div class="sensor-unit">{{ data.temperature.zone1.unit }}</div>
                    <div class="sensor-timestamp" id="temp-zone1-timestamp">{{ data.temperature.zone1.timestamp }}</div>
                </div>
                <div class="sensor-card temperature" id="temp-zone2">
                    <div class="sensor-header">
                        <span class="sensor-title">Temperature</span>
                        <span class="sensor-location">Zone 2</span>
                    </div>
                    <div class="sensor-value">{{ data.temperature.zone2.value }}</div>
                    <div class="sensor-unit">{{ data.temperature.zone2.unit }}</div>
                    <div class="sensor-timestamp" id="temp-zone2-timestamp">{{ data.temperature.zone2.timestamp }}</div>
                </div>
                <div class="sensor-card humidity" id="humidity-zone1">
                    <div class="sensor-header">
                        <span class="sensor-title">Humidity</span>
                        <span class="sensor-location">Zone 1</span>
                    </div>
                    <div class="sensor-value">{{ data.humidity.zone1.value }}</div>
                    <div class="sensor-unit">{{ data.humidity.zone1.unit }}</div>
                    <div class="sensor-timestamp" id="humidity-zone1-timestamp">{{ data.humidity.zone1.timestamp }}</div>
                </div>
                <div class="sensor-card humidity" id="humidity-zone2">
                    <div class="sensor-header">
                        <span class="sensor-title">Humidity</span>
                        <span class="sensor-location">Zone 2</span>
                    </div>
                    <div class="sensor-value">{{ data.humidity.zone2.value }}</div>
                    <div class="sensor-unit">{{ data.humidity.zone2.unit }}</div>
                    <div class="sensor-timestamp" id="humidity-zone2-timestamp">{{ data.humidity.zone2.timestamp }}</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Pressure Sensors</h2>
            <div class="sensor-grid">
                <div class="sensor-card pressure" id="pressure-zone1">
                    <div class="sensor-header">
                        <span class="sensor-title">Pressure</span>
                        <span class="sensor-location">Zone 1</span>
                    </div>
                    <div class="sensor-value">{{ data.pressure.zone1.value }}</div>
                    <div class="sensor-unit">{{ data.pressure.zone1.unit }}</div>
                    <div class="sensor-timestamp" id="pressure-zone1-timestamp">{{ data.pressure.zone1.timestamp }}</div>
                </div>
                <div class="sensor-card pressure" id="pressure-zone2">
                    <div class="sensor-header">
                        <span class="sensor-title">Pressure</span>
                        <span class="sensor-location">Zone 2</span>
                    </div>
                    <div class="sensor-value">{{ data.pressure.zone2.value }}</div>
                    <div class="sensor-unit">{{ data.pressure.zone2.unit }}</div>
                    <div class="sensor-timestamp" id="pressure-zone2-timestamp">{{ data.pressure.zone2.timestamp }}</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Machine Vibration</h2>
            <div class="sensor-grid">
                <div class="sensor-card vibration" id="vibration-machine1">
                    <div class="sensor-header">
                        <span class="sensor-title">Vibration</span>
                        <span class="sensor-location">Machine 1</span>
                    </div>
                    <div class="sensor-value">{{ data.vibration.machine1.value }}</div>
                    <div class="sensor-unit">{{ data.vibration.machine1.unit }}</div>
                    <div class="sensor-timestamp" id="vibration-machine1-timestamp">{{ data.vibration.machine1.timestamp }}</div>
                </div>
                <div class="sensor-card vibration" id="vibration-machine2">
                    <div class="sensor-header">
                        <span class="sensor-title">Vibration</span>
                        <span class="sensor-location">Machine 2</span>
                    </div>
                    <div class="sensor-value">{{ data.vibration.machine2.value }}</div>
                    <div class="sensor-unit">{{ data.vibration.machine2.unit }}</div>
                    <div class="sensor-timestamp" id="vibration-machine2-timestamp">{{ data.vibration.machine2.timestamp }}</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Power Consumption</h2>
            <div class="sensor-grid">
                <div class="sensor-card power" id="power-line1">
                    <div class="sensor-header">
                        <span class="sensor-title">Power</span>
                        <span class="sensor-location">Line 1</span>
                    </div>
                    <div class="sensor-value">{{ data.power.line1.value }}</div>
                    <div class="sensor-unit">{{ data.power.line1.unit }}</div>
                    <div class="sensor-timestamp" id="power-line1-timestamp">{{ data.power.line1.timestamp }}</div>
                </div>
                <div class="sensor-card power" id="power-line2">
                    <div class="sensor-header">
                        <span class="sensor-title">Power</span>
                        <span class="sensor-location">Line 2</span>
                    </div>
                    <div class="sensor-value">{{ data.power.line2.value }}</div>
                    <div class="sensor-unit">{{ data.power.line2.unit }}</div>
                    <div class="sensor-timestamp" id="power-line2-timestamp">{{ data.power.line2.timestamp }}</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Historical Data</h2>
            <div class="chart-container">
                <canvas id="sensorChart"></canvas>
            </div>
        </div>
    </div>

    <div id="debug-info">Waiting for data...</div>

    <script>
        console.log("JavaScript loaded");
        const socket = io();
        const ctx = document.getElementById('sensorChart').getContext('2d');
        const debugInfo = document.getElementById('debug-info');
        
        // Initialize data arrays for each sensor
        const sensorData = {
            temperature: { zone1: [], zone2: [] },
            pressure: { zone1: [], zone2: [] },
            humidity: { zone1: [], zone2: [] },
            vibration: { machine1: [], machine2: [] },
            power: { line1: [], line2: [] }
        };
        let timestamps = [];
        
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: timestamps,
                datasets: [
                    {
                        label: 'Temperature Zone 1 (°C)',
                        data: sensorData.temperature.zone1,
                        borderColor: 'rgb(220, 53, 69)',
                        tension: 0.1
                    },
                    {
                        label: 'Temperature Zone 2 (°C)',
                        data: sensorData.temperature.zone2,
                        borderColor: 'rgb(220, 53, 69, 0.5)',
                        tension: 0.1
                    },
                    {
                        label: 'Pressure Zone 1 (hPa)',
                        data: sensorData.pressure.zone1,
                        borderColor: 'rgb(40, 167, 69)',
                        tension: 0.1
                    },
                    {
                        label: 'Pressure Zone 2 (hPa)',
                        data: sensorData.pressure.zone2,
                        borderColor: 'rgb(40, 167, 69, 0.5)',
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });

        socket.on('connect', () => {
            console.log('Socket.IO connected');
            debugInfo.textContent = 'Socket.IO connected';
        });

        socket.on('disconnect', () => {
            console.log('Socket.IO disconnected');
            debugInfo.textContent = 'Socket.IO disconnected';
        });

        socket.on('sensor_update', function(data) {
            console.log('Received sensor update:', data);
            debugInfo.textContent = `Last update: ${new Date().toLocaleTimeString()}`;
            
            // Update all sensor values and timestamps
            for (const sensorType in data) {
                for (const location in data[sensorType]) {
                    const sensor = data[sensorType][location];
                    const elementId = `${sensorType}-${location}`;
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.querySelector('.sensor-value').textContent = sensor.value;
                        element.querySelector('.sensor-timestamp').textContent = new Date(sensor.timestamp).toLocaleString();
                        
                        // Update chart data
                        if (sensorType === 'temperature' || sensorType === 'pressure') {
                            sensorData[sensorType][location].push(sensor.value);
                        }
                    } else {
                        console.warn(`Element not found: ${elementId}`);
                    }
                }
            }
            
            // Update timestamps
            timestamps.push(new Date(data.temperature.zone1.timestamp).toLocaleTimeString());
            
            // Keep only last 20 data points
            if (timestamps.length > 20) {
                timestamps.shift();
                for (const sensorType in sensorData) {
                    for (const location in sensorData[sensorType]) {
                        sensorData[sensorType][location].shift();
                    }
                }
            }
            
            chart.update();
        });
    </script>
</body>
</html> 